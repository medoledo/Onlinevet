{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Bought Items</h1>

    <form method="GET" action="{% url 'bought' %}" class="mb-4" id="search-form">
        <div class="row">
            <div class="col-md-4">
                <input type="text" name="search" id="search-box" class="form-control" placeholder="Search by item name" value="{{ query }}">
            </div>
            <div class="col-md-3">
                <input type="date" name="start_date" id="start-date" class="form-control" value="{{ start_date }}">
            </div>
            <div class="col-md-3">
                <input type="date" name="end_date" id="end-date" class="form-control" value="{{ end_date }}">
            </div>
            <div class="col-md-2">
                <a href="{% url 'download_bought_excel' %}" class="btn btn-success">Download Excel</a>
            </div>
        </div>
    </form>

    <a href="{% url 'add_bought_item' %}" class="btn btn-primary mb-3">Add Bought Item</a>

    <table class="table table-bordered table-hover shadow-sm">
        <thead class="table-dark">
            <tr>
                <th>Item</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Total Price</th>
                <th>Date of Buying</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="bought-items-body">
            {% for item in items %}
                <tr>
                    <td>{{ item.item }}</td>
                    <td>{{ item.price }}</td>
                    <td>{{ item.quantity }}</td>
                    <td class="total-price">{{ item.total_price }}</td>
                    <td>{{ item.date_of_buying }}</td>
                    <td>
                        <a href="{% url 'edit_bought_item' item.id %}" class="btn btn-warning btn-sm">Edit</a>
                        <a href="{% url 'delete_bought_item' item.id %}" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this item?')">Delete</a>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="6" class="text-center">No items found</td>
                </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr class="table-info">
                <td colspan="3" class="text-end"><strong>Total:</strong></td>
                <td id="sum-total-price"><strong>{{ total_bought|floatformat:2 }}</strong></td>
                <td colspan="2"></td>
            </tr>
        </tfoot>
    </table>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchBox = document.getElementById('search-box');
        const startDate = document.getElementById('start-date');
        const endDate = document.getElementById('end-date');
        const itemsBody = document.getElementById('bought-items-body');
        const totalPriceBox = document.getElementById('sum-total-price');

        function fetchResults() {
            let query = searchBox.value;
            let start_date = startDate.value;
            let end_date = endDate.value;

            fetch(`{% url 'bought' %}?search=${query}&start_date=${start_date}&end_date=${end_date}`, {
                headers: { "X-Requested-With": "XMLHttpRequest" }
            })
            .then(response => response.json())
            .then(data => {
                itemsBody.innerHTML = "";  // Clear table before adding new data
                let totalSum = 0;

                if (data.items.length > 0) {
                    data.items.forEach(item => {
                        let itemTotal = parseFloat(item.total_price) || 0;
                        totalSum += itemTotal;

                        let row = `
                            <tr>
                                <td>${item.item}</td>
                                <td>${item.price}</td>
                                <td>${item.quantity}</td>
                                <td class="total-price">${itemTotal.toFixed(2)}</td>
                                <td>${item.date_of_buying}</td>
                                <td>
                                    <a href="/edit_bought_item/${item.id}" class="btn btn-warning btn-sm">Edit</a>
                                    <a href="/delete_bought_item/${item.id}" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this item?')">Delete</a>
                                </td>
                            </tr>`;
                        itemsBody.innerHTML += row;
                    });
                } else {
                    itemsBody.innerHTML = `<tr><td colspan="6" class="text-center">No items found</td></tr>`;
                }

                // Update total sum
                totalPriceBox.innerHTML = `<strong>${totalSum.toFixed(2)}</strong>`;
            })
            .catch(error => console.error("Error fetching items:", error));
        }

        // Trigger search on input changes
        searchBox.addEventListener('input', fetchResults);
        startDate.addEventListener('change', fetchResults);
        endDate.addEventListener('change', fetchResults);
    });
</script>
{% endblock %}
