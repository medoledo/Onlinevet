{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container">
    <h1>Create Invoice</h1>

    {% if error_message %}
        <div class="alert alert-danger">
            {{ error_message }}
        </div>
    {% endif %}

    <form method="post">
        {% csrf_token %}
        
        <table class="table table-bordered" id="invoiceTable">
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Item</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Discount</th>
                    <th>Total Price</th>
                    <th>Expiration Date</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <!-- Default first row will be added here -->
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="5"></td>
                    <td><input type="text" id="totalPrice" class="form-control" readonly style="width: 150px; display: inline-block;"></td>
                    <td></td>
                </tr>
            </tfoot>
        </table>

        <br><br>
        <button type="button" class="btn btn-primary" id="addRowBtn">Add Row</button>

        <br><br>
        <div style="padding-bottom: 150px;">
            <button type="submit" class="btn btn-success">Create Invoice</button>
        </div>
    </form>
</div>

<script>
    function getItemsByCategory(selectElement) {
        const categoryId = selectElement.value;
        const row = selectElement.closest('tr');
        const itemSelect = row.querySelector('.item-select');

        if (categoryId) {
            fetch(`/get-items/${categoryId}/`)
                .then(response => response.json())
                .then(data => {
                    itemSelect.innerHTML = `<option value="">Select Item</option>`;
                    data.items.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.textContent = item.name;
                        option.setAttribute('data-price', item.price);
                        option.setAttribute('data-exp', item.exp);

                        if (item.out_of_stock) {
                            option.style.color = "red"; 
                        }

                        itemSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error("Error fetching items:", error);
                });
        }
    }

    document.getElementById('invoiceTable').addEventListener('change', function(event) {
        if (event.target.classList.contains('item-select') || event.target.classList.contains('quantity-input') || event.target.classList.contains('discount-input')) {
            const row = event.target.closest('tr');
            const priceInput = row.querySelector('.price-input');
            const totalPriceInput = row.querySelector('.total-price-input');
            const quantityInput = row.querySelector('.quantity-input');
            const discountInput = row.querySelector('.discount-input');
            const expInput = row.querySelector('.exp-input');

            const selectedItem = row.querySelector('.item-select').selectedOptions[0];
            const price = parseFloat(selectedItem.getAttribute('data-price')) || 0;
            const quantity = parseFloat(quantityInput.value) || 0;
            const discount = parseFloat(discountInput.value) || 0;
            const total = (price * quantity) - discount;

            priceInput.value = price.toFixed(2);
            expInput.value = selectedItem.getAttribute('data-exp');
            totalPriceInput.value = total.toFixed(2);

            updateTotalPrice();
        }
    });

    function updateTotalPrice() {
        let totalPrice = 0;

        document.querySelectorAll('.total-price-input').forEach(function(input) {
            totalPrice += parseFloat(input.value) || 0;
        });

        document.getElementById('totalPrice').value = totalPrice.toFixed(2);
    }

    // Function to create and append a new row
    function createNewRow() {
        const row = document.createElement('tr');

        row.innerHTML = `
            <td>
                <select name="category[]" class="form-control" onchange="getItemsByCategory(this)" style="width: 200px;">
                    <option value="">Select Category</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
            </td>
            <td>
                <select name="item[]" class="form-control item-select" style="width: 200px;">
                    <option value="">Select Item</option>
                </select>
            </td>
            <td><input type="text" name="price[]" class="form-control price-input" readonly></td>
            <td><input type="number" step="any" name="quantity[]" class="form-control quantity-input" min="0" value="1"></td>
            <td><input type="number" name="discount[]" class="form-control discount-input" min="0" value="0"></td>
            <td><input type="text" name="total_price[]" class="form-control total-price-input" readonly></td>
            <td><input type="text" name="exp[]" class="form-control exp-input" readonly></td>
            <td><button type="button" class="btn btn-danger remove-row">Remove</button></td>
        `;

        // Append the new row to the table body
        document.querySelector('#invoiceTable tbody').appendChild(row);
    }

    document.getElementById('addRowBtn').addEventListener('click', function() {
        createNewRow(); // Call the function to add a new row
    });

    document.getElementById('invoiceTable').addEventListener('click', function(event) {
        if (event.target.classList.contains('remove-row')) {
            const row = event.target.closest('tr');
            row.remove();
            updateTotalPrice();
        }
    });

    // Add the first row when the page loads
    window.onload = function() {
        createNewRow(); // Add the default first row
    }
</script>
{% endblock %}
